new function(_1){var IO=new base2.Package(this,{name:"IO",version:"0.8",imports:"Function2,Enumerable",exports:"FileSystem,Directory,LocalFileSystem,LocalDirectory,LocalFile,JSONFileSystem,JSONDirectory"});eval(this.imports);function NOT_SUPPORTED(){throw new Error("Not supported.");};var XPCOM=Module.extend({privelegedMethod:I,privelegedObject:I,"@(Components)":{createObject:function(a,b){if(a.charAt(0)!="@"){a="@mozilla.org/"+a}try{return new(new Components.Constructor(a,b))}catch(error){throw new Error(format("Failed to create object '%1' (%2).",b,error.message));}},privelegedMethod:function(a){return function(){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");return a.apply(this,arguments)}},privelegedObject:function(c){Base.forEach(c,function(a,b){if(typeof a=="function"){c[b]=XPCOM.privelegedMethod(a)}})}}});var FileSystem=Base.extend({path:"/",chdir:function(a){a=this.makepath(a);if(!/\/$/.test(a)){if(this.isDirectory(a)){a+="/"}else{a=a.replace(/[^\/]+$/,"")}}this.path=a},makepath:function(a,b){if(arguments.length==1){b=a;a=this.path}return FileSystem.resolve(a,b)},copy:NOT_SUPPORTED,exists:NOT_SUPPORTED,isDirectory:NOT_SUPPORTED,isFile:NOT_SUPPORTED,mkdir:NOT_SUPPORTED,move:NOT_SUPPORTED,read:NOT_SUPPORTED,remove:NOT_SUPPORTED,write:NOT_SUPPORTED},{resolve:function(a,b){var c=/[^\/]+$/;var d=/\/[^\/]+\/\.\./;a=String(a||"");b=String(b||"");if(b.charAt(0)=="/"){var e=""}else{e=a.replace(c,"")}e+=b;while(d.test(e)){e=e.replace(d,"")}return e}});var Directory=Collection.extend({sort:function(){return this.base(function(a,b,c,d){if(a.isDirectory!=b.isDirectory){return a.isDirectory?-1:1}else{return c<d?-1:1}})}},{Item:{constructor:function(a,b,c){this.name=String(a);this.isDirectory=Boolean(b);this.size=Number(c||0)},toString:function(){return this.name}}});var LocalFileSystem=FileSystem.extend({read:function(a){return LocalFile.read(a)},write:function(a,b){return LocalFile.write(a,b)},"@(ActiveXObject)":{constructor:function(){this.$fso=new ActiveXObject("Scripting.FileSystemObject")},copy:function(a,b){var c=this.isDirectory(a)?"CopyFolder":"CopyFile";this.$fso[c](a,b,true)},exists:function(a){return this.isFile()||this.isDirectory()},isFile:function(a){return this.$fso.FileExists(a)},isDirectory:function(a){return this.$fso.FolderExists(a)},mkdir:function(a){return this.$fso.CreateFolder(a)},move:function(a,b){var c=this.isDirectory(a)?"MoveFolder":"MoveFile";this.$fso[c](a,b)},read:function(a){if(this.isDirectory(a)){return new LocalDirectory(this.$fso.GetFolder(a))}return this.base(a)},remove:function(a){if(this.isFile(a)){this.$fso.DeleteFile(a)}else if(this.isDirectory(a)){this.$fso.DeleteFolder(a)}}},"@(Components)":{constructor:function(){this.$nsILocalFile=LocalFile.$createObject()},copy:function(a,b){return this.$nsILocalFile.copyTo(b)},exists:function(a){return this.$nsILocalFile.exists()},isFile:function(a){return this.exists()&&this.$nsILocalFile.isFile()},isDirectory:function(a){return this.exists()&&this.$nsILocalFile.isDirectory()},mkdir:function(a){return this.$nsILocalFile.create(1)},move:function(a,b){return this.$nsILocalFile.moveTo(b)},read:function(a){if(this.isDirectory(a)){return new LocalDirectory(this.$nsILocalFile.directoryEntries)}return this.base(a)},remove:function(a){this.$nsILocalFile.remove(false)}},"@(java && !global.Components)":{exists:function(a){return new java.io.File(a).exists()}}},{"@(Components)":{init:function(){XPCOM.privelegedObject(this.prototype)}}});var LocalDirectory=Directory.extend({"@(ActiveXObject)":{constructor:function(a){this.base();var b=a.files;var c=b.Count();for(var d=0;d<c;d++){this.put(b.item(d))}}},"@(Components)":{constructor:XPCOM.privelegedMethod(function(a){this.base();var b=a.QueryInterface(Components.interfaces.nsIDirectoryEnumerator);while(b.hasMoreElements()){this.put(b.nextFile)}})}},{"@(ActiveXObject)":{create:function(a,b){return new this.Item(b.Name,b.Type|16,b.Size)}},"@(Components)":{create:function(a,b){return new this.Item(b.leafName,b.isDirectory(),b.fileSize)}}});var LocalFile=Base.extend({constructor:function(a,b){assignID(this);this.path=LocalFile.makepath(a);if(b)this.open(b)},mode:0,path:"",close:function(){delete LocalFile.opened[this.base2ID];delete this.$stream;this.mode=LocalFile.CLOSED},open:function(a){this.mode=a||LocalFile.READ;LocalFile.opened[this.base2ID]=this},exists:NOT_SUPPORTED,read:NOT_SUPPORTED,remove:NOT_SUPPORTED,write:NOT_SUPPORTED,"@(ActiveXObject)":{constructor:function(a,b){this.$fso=new ActiveXObject("Scripting.FileSystemObject");this.base(a,b)},close:function(){if(this.$stream){this.$stream.Close();this.base()}},exists:function(){return this.$fso.FileExists(this.path)},open:function(a){if(!this.$stream){this.base(a);switch(this.mode){case LocalFile.READ:if(!this.exists()){this.mode=LocalFile.CLOSED;break}this.$stream=this.$fso.OpenTextFile(this.path,1);break;case LocalFile.WRITE:this.$stream=this.$fso.OpenTextFile(this.path,2,-1,0);break}}},read:function(){return this.$stream.ReadAll()},remove:function(){return this.$fso.GetFile(this.path).Delete()},write:function(a){this.$stream.Write(a||"")}},"@(Components)":{constructor:function(a,b){this.$nsILocalFile=LocalFile.$createObject();this.base(a,b)},$init:function(){var a=this.$nsILocalFile;try{a.initWithPath(this.path)}catch(error){a.initWithPath(location.pathname);a.setRelativeDescriptor(a,this.path)}return a},close:function(){if(this.$stream){if(this.mode==LocalFile.WRITE)this.$stream.flush();this.$stream.close();this.base()}},exists:function(){return this.$init().exists()},open:function(a){if(!this.$stream){this.base(a);var b=this.$init();switch(this.mode){case LocalFile.READ:if(!b.exists()){this.mode=LocalFile.CLOSED;break}var c=XPCOM.createObject("network/file-input-stream;1","nsIFileInputStream");c.init(b,0x01,00004,null);this.$stream=XPCOM.createObject("scriptableinputstream;1","nsIScriptableInputStream");this.$stream.init(c);break;case LocalFile.WRITE:if(!b.exists())b.create(0,0664);this.$stream=XPCOM.createObject("network/file-output-stream;1","nsIFileOutputStream");this.$stream.init(b,0x20|0x02,00004,null);break}}},read:function(){return this.$stream.read(this.$stream.available())},remove:function(){this.$init().remove(false)},write:function(a){if(a==null)a="";this.$stream.write(a,a.length)}},"@(java && !global.Components)":{close:function(){if(this.$stream){this.$stream.close();this.base()}},exists:function(){return new java.io.File(this.path).exists()},open:function(a){if(!this.$stream){this.base(a);switch(this.mode){case LocalFile.READ:var b=new java.io.FileReader(this.path);this.$stream=new java.io.BufferedReader(b);break;case LocalFile.WRITE:var b=new java.io.FileOutputStream(this.path);this.$stream=new java.io.PrintStream(b);break}}},read:function(){var a=[];var b,c=0;while((b=this.$stream.readLine())!=null){a[c++]=b}return a.join("\r\n")},write:function(a){this.$stream.print(a||"")}}},{CLOSED:0,READ:1,WRITE:2,opened:{},backup:function(a,b){var c=this.read(a);this.write(b||(a+".backup"),c);return c},closeAll:function(){var a=this.opened;for(var b in a)a[b].close()},exists:function(a){return new this(a).exists()},makepath:function(a){var b=/[^\/]+$/;var c=location.pathname.replace(b,"");c=FileSystem.resolve(c,a);return decodeURIComponent(c)},"@win(32|64)":{makepath:function(a){var b=/\//g;var c=/\\/g;var d=/[^\/]+$/;a=String(a||"").replace(c,"/");var e=location.pathname.replace(c,"/").replace(d,"");e=FileSystem.resolve(e,a).slice(1);return decodeURIComponent(e.replace(b,"\\"))}},read:function(a){var b=new this(a,this.READ);var c=b.mode?b.read():"";b.close();return c},remove:function(a){var b=new this(a);b.remove()},write:function(a,b){var c=new this(a,this.WRITE);c.write(b);c.close()},"@(Components)":{init:function(){XPCOM.privelegedObject(this.prototype);this.$createObject=XPCOM.privelegedMethod(function(){return XPCOM.createObject("file/local;1","nsILocalFile")})}}});var _0="#fetch";var JSONFileSystem=FileSystem.extend({constructor:function(d){this[_0]=function(c){c=this.makepath(c);return reduce(c.split("/"),function(a,b){if(a&&b)a=(undefined===a[b])?undefined:a[b];return a},d)}},exists:function(a){return this[_0](a)!==undefined},isFile:function(a){return typeof this[_0](a)=="string"},isDirectory:function(a){return typeof this[_0](a)=="object"},copy:function(a,b){var c=this[_0](a);this.write(b,JSON.copy(c))},mkdir:function(a){this.write(a,{})},move:function(a,b){var c=this[_0](a);this.write(b,c);this.remove(a)},read:function(a){var b=this[_0](a);return typeof b=="object"?new JSONDirectory(b):b||""},remove:function(a){a=a.replace(/\/$/,"").split("/");var b=a.splice(a.length-1,1);var c=this[_0](a.join("/"));if(c)delete c[b]},write:function(a,b){a=a.split("/");var c=a.splice(a.length-1,1);var d=this[_0](a.join("/"));assert(d,"Directory not found.");return d[c]=b||""}});var JSONDirectory=Directory.extend(null,{create:function(a,b){return new this.Item(a,typeof b=="object",typeof b=="string"?b.length:0)}});eval(this.exports)};